@if (loading) {
  <div class="loadingcharity">Loading charity…</div>
} @else if (!charity) {
  <div class="loadingcharity">Charity not found.</div>
} @else {
  <section class="charity">
    <div class="top">
      <div class="left">
        <img [src]="charity.picture || '/assets/logo-contrast.png'" [alt]="charity.name + ' logo'">
        <div class="title-wrap">
          <h1>{{ charity.name }}</h1>
          @if (charity.charity.shortDescription || charity.about) {
            <p class="short-description">{{ charity.charity.shortDescription || charity.about }}</p>
          }
          @if (charity.website) {
            <a class="website" target="_blank" [href]="charity.website">{{ charity.website }}</a>
          }
        </div>
      </div>

      @if (canEdit) {
        <div class="top-actions">
          <a routerLink="/charity/profile"><button mat-stroked-button type="button">Edit charity profile</button></a>
        </div>
      }
    </div>

    <div class="stats-row">
      <span class="stat-chip">{{ charity.charity.category || 'Uncategorized' }}</span>
      @if (charity.charity.country) {
        <span class="stat-chip">{{ charity.charity.country }}</span>
      }
      <span class="stat-chip">{{ charity.followers }} followers</span>
      <span class="stat-chip">{{ charity.ratingAvg ? (charity.ratingAvg | number:'1.1-2') : '0.0' }} / 5 ({{ charity.ratingCount }} ratings)</span>
      <span class="stat-chip">{{ charity.zappedSats | number }} sats zapped</span>
      <span class="stat-chip">{{ charity.flags }} flags</span>
    </div>

    <div class="middle">
      <div class="left">
        <h3>More about {{ charity.name }}</h3>
        <div class="description">
          {{ charity.charity.description || charity.charity.mission || 'No charity description yet.' }}
        </div>

        <div class="meta-block">
          <p><strong>Nostr profile:</strong> {{ nostrProfileUri }}</p>
          <div class="profile-links">
            <button type="button" (click)="copyNostrProfileUri()">Copy nostr link</button>
            <a [href]="primalProfileUrl" target="_blank" rel="noopener noreferrer">Open on Primal</a>
            <a [href]="njumpProfileUrl" target="_blank" rel="noopener noreferrer">Open on njump</a>
          </div>
        </div>
      </div>

      <div class="right">
        <div class="donate">
          <h2>Donate</h2>
          <p class="donation-text">
            Send directly with lightning/zap to:
            <strong>{{ donationAddress || 'No address' }}</strong>
          </p>

          <div class="amount-box">
            <div class="amount-row">
              <input
                type="number"
                min="1"
                [(ngModel)]="donationInput"
                name="donationInput"
                [placeholder]="donationMode === 'sats' ? 'Amount in sats' : 'Amount in USD'" />
              <span class="unit">{{ donationMode === 'sats' ? 'sats' : 'USD' }}</span>
              <button type="button" class="switch-btn" (click)="toggleDonationMode()" title="Switch sats/USD">
                <i class="fa-solid fa-right-left"></i>
              </button>
            </div>
            <p class="converted">{{ convertedHint }}</p>
            <button type="button" class="donate-btn" (click)="donate()" [disabled]="!canDonate">
              {{ donating ? 'Creating invoice…' : 'Zap / Donate now' }}
            </button>
            <p class="donation-help">If no wallet opens on desktop, use <strong>Show QR</strong> and scan with your phone wallet.</p>
            @if (donationStatus) {
              <p class="donation-status">{{ donationStatus }}</p>
            }
            @if (lastInvoice) {
              <div class="invoice-box">
                <small>{{ lastInvoice.slice(0, 40) }}…</small>
                <div class="invoice-actions">
                  <button type="button" (click)="openQrModal()">Show QR</button>
                  <button type="button" (click)="copyInvoice()">Copy invoice</button>
                </div>
              </div>
            }
          </div>

          <div class="actions-row">
            <button type="button" class="icon-action" (click)="openRateDialog()" title="Rate charity">
              <i class="fa-solid fa-star"></i>
              <span>Rate</span>
            </button>
            <button type="button" class="icon-action" (click)="openFlagDialog()" title="Flag charity">
              <i class="fa-solid fa-flag"></i>
              <span>Flag</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  @if (showRateDialog) {
    <div class="dialog-overlay" (click)="closeRateDialog()">
      <div class="dialog-card" (click)="$event.stopPropagation()">
        <h3>Rate this charity</h3>
        <label>Rating (1-5)</label>
        <input type="number" min="1" max="5" [(ngModel)]="rating" name="rating" />
        <label>Note (optional)</label>
        <textarea [(ngModel)]="ratingNote" name="ratingNote"></textarea>
        <div class="dialog-actions">
          <button type="button" (click)="closeRateDialog()">Cancel</button>
          <button type="button" (click)="rate()">Publish rating</button>
        </div>
      </div>
    </div>
  }

  @if (showFlagDialog) {
    <div class="dialog-overlay" (click)="closeFlagDialog()">
      <div class="dialog-card" (click)="$event.stopPropagation()">
        <h3>Flag this charity</h3>
        <label>Reason</label>
        <select [(ngModel)]="reportReason" name="reportReason">
          <option value="scam">Scam</option>
          <option value="spam">Spam</option>
          <option value="impersonation">Impersonation</option>
        </select>
        <label>Details</label>
        <textarea [(ngModel)]="reportNote" name="reportNote"></textarea>
        <div class="dialog-actions">
          <button type="button" (click)="closeFlagDialog()">Cancel</button>
          <button type="button" (click)="report()">Publish flag</button>
        </div>
      </div>
    </div>
  }

  @if (showQrModal) {
    <div class="qr-overlay" (click)="closeQrModal()">
      <div class="qr-modal" (click)="$event.stopPropagation()">
        <h3>Scan to pay</h3>
        @if (qrDataUrl) {
          <img [src]="qrDataUrl" alt="Lightning invoice QR" />
        } @else {
          <p>QR preview unavailable in this browser. Use copy invoice.</p>
        }
        <p class="qr-help">If your wallet did not open, scan this QR from your phone wallet.</p>
        <div class="qr-actions">
          <button type="button" (click)="copyInvoice()">Copy invoice</button>
          <button type="button" (click)="closeQrModal()">Close</button>
        </div>
      </div>
    </div>
  }
}
