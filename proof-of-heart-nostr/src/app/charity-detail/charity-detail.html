@if (loading) {
  <div class="loadingcharity">Loading charity…</div>
} @else if (!charity) {
  <div class="loadingcharity">Charity not found.</div>
} @else {
  <section class="charity">
    <div class="top">
      <div class="left">
        <img [src]="charity.picture || '/assets/logo-contrast.png'" [alt]="charity.name + ' logo'">
        <h1>{{ charity.name }}</h1>
      </div>
      <div class="right">
        <ul>
          @if (charity.website) {
            <li>
              <i class="fa-solid fa-globe"></i>
              <a target="_blank" [href]="charity.website">{{ charity.website }}</a>
            </li>
          }
          <li>
            <i class="fa-solid fa-folder"></i>
            {{ charity.charity.category || 'Uncategorized' }}
          </li>
          @if (charity.charity.country) {
            <li>
              <i class="fa-solid fa-location-dot"></i>
              {{ charity.charity.country }}
            </li>
          }
          <li>
            <i class="fa-solid fa-users"></i>
            {{ charity.followers }} followers
          </li>
          <li>
            <i class="fa-solid fa-bolt"></i>
            {{ charity.zappedSats | number }} sats zapped (queried relays)
          </li>
          <li>
            <i class="fa-solid fa-flag"></i>
            {{ charity.flags }} flags
          </li>
        </ul>
      </div>
    </div>

    <div class="middle">
      <div class="left">
        <h3>More about {{ charity.name }}</h3>
        <div class="description">
          {{ charity.about || charity.charity.mission || 'No charity description yet.' }}
        </div>

        @if (canEdit) {
          <p class="edit-wrap">
            <a routerLink="/charity/profile"><button type="button">Edit charity profile</button></a>
          </p>
        }

        <div class="meta-block">
          <p><strong>Npub:</strong> {{ charity.npub }}</p>
          <p><strong>Donation message:</strong> {{ charity.charity.donationMessage || '—' }}</p>
        </div>
      </div>

      <div class="right">
        <div class="donate">
          <h2>Donate</h2>
          <p class="donation-text">
            Send directly with lightning/zap to:
            <strong>{{ donationAddress || 'No address' }}</strong>
          </p>

          <div class="amount-box">
            <div class="amount-row">
              <input
                type="number"
                min="1"
                [(ngModel)]="donationInput"
                name="donationInput"
                [placeholder]="donationMode === 'sats' ? 'Amount in sats' : 'Amount in USD'" />
              <span class="unit">{{ donationMode === 'sats' ? 'sats' : 'USD' }}</span>
              <button type="button" class="switch-btn" (click)="toggleDonationMode()" title="Switch sats/USD">
                <i class="fa-solid fa-right-left"></i>
              </button>
            </div>
            <p class="converted">{{ convertedHint }}</p>
            <button type="button" class="donate-btn" (click)="donate()" [disabled]="!canDonate">
              {{ donating ? 'Creating invoice…' : 'Zap / Donate now' }}
            </button>
            <p class="donation-help">If no wallet opens on desktop, use <strong>Show QR</strong> and scan with your phone wallet.</p>
            @if (donationStatus) {
              <p class="donation-status">{{ donationStatus }}</p>
            }
            @if (lastInvoice) {
              <div class="invoice-box">
                <small>{{ lastInvoice.slice(0, 40) }}…</small>
                <div class="invoice-actions">
                  <button type="button" (click)="openQrModal()">Show QR</button>
                  <button type="button" (click)="copyInvoice()">Copy invoice</button>
                </div>
              </div>
            }
          </div>

          <div class="forms">
            <form (ngSubmit)="rate()">
              <h3>Rate this charity</h3>
              <label>Rating (1-5)</label>
              <input type="number" min="1" max="5" [(ngModel)]="rating" name="rating" />
              <label>Note (optional)</label>
              <textarea [(ngModel)]="ratingNote" name="ratingNote"></textarea>
              <button type="submit">Publish rating</button>
            </form>

            <form (ngSubmit)="report()">
              <h3>Flag this charity</h3>
              <label>Reason</label>
              <select [(ngModel)]="reportReason" name="reportReason">
                <option value="scam">Scam</option>
                <option value="spam">Spam</option>
                <option value="impersonation">Impersonation</option>
              </select>
              <label>Details</label>
              <textarea [(ngModel)]="reportNote" name="reportNote"></textarea>
              <button type="submit">Publish flag</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>

  @if (showQrModal) {
    <div class="qr-overlay" (click)="closeQrModal()">
      <div class="qr-modal" (click)="$event.stopPropagation()">
        <h3>Scan to pay</h3>
        @if (qrDataUrl) {
          <img [src]="qrDataUrl" alt="Lightning invoice QR" />
        } @else {
          <p>QR preview unavailable in this browser. Use copy invoice.</p>
        }
        <p class="qr-help">If your wallet did not open, scan this QR from your phone wallet.</p>
        <div class="qr-actions">
          <button type="button" (click)="copyInvoice()">Copy invoice</button>
          <button type="button" (click)="closeQrModal()">Close</button>
        </div>
      </div>
    </div>
  }
}
